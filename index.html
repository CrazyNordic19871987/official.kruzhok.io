<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Кружок.OK - Найди кружки для ребенка в Москве</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 0; padding: 0; background-color: #f5f5f5; }
        header { background-color: #4CAF50; color: white; padding: 1rem; text-align: center; }
        .search-bar { margin-top: 1rem; display: flex; gap: 10px; justify-content: center; flex-wrap: wrap; }
        .search-bar input, .search-bar select { padding: 8px; border: 1px solid #ddd; border-radius: 4px; }
        button { padding: 8px 15px; background: #fff; border: 1px solid #ccc; border-radius: 4px; cursor: pointer; }
        button:hover { background: #f0f0f0; }
        #map { width: 100%; height: 400px; margin: 20px 0; }
        .results-container { padding: 0 20px; }
        .results-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; padding: 20px 0; }
        .place-card { background: white; border-radius: 8px; padding: 15px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .place-card:hover { box-shadow: 0 4px 8px rgba(0,0,0,0.15); }
        .place-card h3 { margin-top: 0; color: #333; }
    </style>
    <script src="https://api-maps.yandex.ru/2.1/?apikey=73a4825a-3afa-47c2-9241-df3665eaa73f&lang=ru_RU" type="text/javascript"></script>
</head>
<body>
    <header>
        <h1>Кружок.OK</h1>
        <div class="search-bar">
            <input type="text" id="searchInput" placeholder="Например, робототехника...">
            <select id="categoryFilter">
                <option value="">Все направления</option>
                <option value="Техническое">Техническое</option>
                <option value="Творческое">Творческое</option>
                <option value="Спортивное">Спортивное</option>
                <option value="Научное">Научное</option>
                <option value="Языковое">Языковое</option>
            </select>
            <button onclick="performSearch()">Найти</button>
        </div>
    </header>

    <main>
        <div id="map"></div>
        
        <div class="results-container">
            <h2>Найдено кружков: <span id="resultsCount">0</span></h2>
            <div id="resultsList" class="results-list"></div>
        </div>
    </main>

    <script>
        // Конфигурация Airtable
        const AIRTABLE_API_KEY = 'patZudd3eZOcrhroz.b1307f7e37e3d583ff1750c59cc8291bfe3e9a8d2c1531d89350c38cee5a44ad';
        const AIRTABLE_BASE_ID = 'app8oCy3oQts8aPk3';
        const AIRTABLE_TABLE_NAME = 'Circles';
        const TALLY_FORM_URL = 'https://tally.so/r/mVg4Ol';

        let map;
        let placemarks = [];
        let allCircles = [];

        // Загрузка данных из Airtable
        async function loadCirclesFromAirtable() {
            const url = `https://api.airtable.com/v0/${AIRTABLE_BASE_ID}/${AIRTABLE_TABLE_NAME}`;
            try {
                const response = await fetch(url, { headers: { 'Authorization': `Bearer ${AIRTABLE_API_KEY}` } });
                const data = await response.json();
                return data.records.map(record => ({ id: record.id, ...record.fields }));
            } catch (error) {
                console.error('Ошибка загрузки данных:', error);
                return [];
            }
        }

        // Инициализация карты
        function initMap() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    position => createMap([position.coords.latitude, position.coords.longitude]),
                    error => createMap([55.7558, 37.6173])
                );
            } else {
                createMap([55.7558, 37.6173]);
            }
        }

        function createMap(center) {
            map = new ymaps.Map('map', { center: center, zoom: 11 });
        }

        // Добавление меток на карту
        function addPlacemarks(circles) {
            placemarks.forEach(mark => map.geoObjects.remove(mark));
            placemarks = [];
            circles.forEach(circle => {
                if (circle.Lat && circle.Lon) {
                    const placemark = new ymaps.Placemark([circle.Lat, circle.Lon], {
                        balloonContent: `<strong>${circle.Name}</strong><br>${circle.Address}`
                    });
                    placemarks.push(placemark);
                    map.geoObjects.add(placemark);
                }
            });
            if (placemarks.length > 0) map.setBounds(map.geoObjects.getBounds());
        }

        // Поиск и фильтрация
        function performSearch() {
            const searchText = document.getElementById('searchInput').value.toLowerCase();
            const category = document.getElementById('categoryFilter').value;
            const filteredCircles = allCircles.filter(circle => {
                const matchesSearch = circle.Name?.toLowerCase().includes(searchText) || circle.Description?.toLowerCase().includes(searchText);
                const matchesCategory = !category || circle.Category === category;
                return matchesSearch && matchesCategory && circle.IsActive;
            });
            displayCircles(filteredCircles);
        }

        // Отображение кружков
        function displayCircles(circles) {
            document.getElementById('resultsCount').textContent = circles.length;
            addPlacemarks(circles);
            const resultsList = document.getElementById('resultsList');
            resultsList.innerHTML = '';
            circles.forEach(circle => {
                const card = document.createElement('div');
                card.className = 'place-card';
                card.innerHTML = `
                    <h3>${circle.Name || 'Без названия'}</h3>
                    <p><strong>Направление:</strong> ${circle.Category || 'Не указано'}</p>
                    <p><strong>Возраст:</strong> ${circle.AgeMin || '?'}-${circle.AgeMax || '?'} лет</p>
                    <p><strong>Адрес:</strong> ${circle.Address || 'Не указан'}</p>
                    <button onclick="openCircleDetail('${circle.id}', '${circle.Name}')">Записаться на пробное</button>
                `;
                resultsList.appendChild(card);
            });
        }

        // Открытие формы записи
        function openCircleDetail(circleId, circleName) {
            window.open(`${TALLY_FORM_URL}?circle=${encodeURIComponent(circleName)}`, '_blank');
        }

        // Запуск приложения после загрузки страницы
        document.addEventListener('DOMContentLoaded', async () => {
            ymaps.ready(initMap);
            allCircles = await loadCirclesFromAirtable();
            displayCircles(allCircles);
        });
    </script>
</body>
</html>
